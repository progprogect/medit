# AI Video Editing — Архитектура решения

> **Версия:** 1.1  
> **Дата:** 13 февраля 2025  
> **Модель анализа видео:** Google Gemini 2.5  
> **Тестовый UI:** Включён в MVP

---

## 1. Обзор системы

Система позволяет пользователю загрузить видео, описать желаемый результат текстом, и получить готовое обработанное видео. LLM (Gemini) генерирует JSON с последовательностью задач, которые выполняет FFmpeg.

### Пользовательский сценарий

1. **Загрузка** — пользователь загружает 1 видео
2. **Запрос** — вводит текст: какой текст наложить, как обработать видео
3. **Анализ** — Gemini получает видео + промпт → генерирует JSON с задачами
4. **Исполнение** — система выполняет задачи через FFmpeg
5. **Результат** — пользователь скачивает готовое видео

### Расширяемость

- Добавление новых типов задач (эффекты, обрезка, скорость и т.д.)
- LLM генерирует «задание» (JSON), исполнение — детерминированными алгоритмами
- Возможность интеграции LangChain для сложных сценариев в будущем

---

## 2. Выбор технологий

| Компонент | Решение | Обоснование |
|-----------|---------|-------------|
| **Анализ видео + генерация JSON** | Google Gemini 2.5 Flash | Нативное видео, Structured Outputs, без извлечения кадров |
| **Обработка видео** | FFmpeg (subprocess / ffmpeg-python) | Быстро, мало памяти, подходит для Lambda/EC2 |
| **API** | FastAPI | Асинхронность, типизация, presigned URLs |
| **Хранилище** | Amazon S3 | Стандарт для медиа, presigned URLs для загрузки/скачивания |
| **Инфраструктура MVP** | EC2 + S3 | Минимальная сложность, нет лимитов Lambda |
| **Тестовый UI** | HTML + vanilla JS | Статика из FastAPI, без сборки |

---

## 3. Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    Тестовый веб-интерфейс                         │
│  [Загрузка видео] [Поле промпта] [Обработать] [Превью] [Скачать]  │
└──────────────────────────────┬──────────────────────────────────┘
                                │
                                ▼
┌─────────────┐     ┌──────────────────┐     ┌─────────────┐
│   Браузер   │────▶│   API (FastAPI)   │────▶│     S3      │
│  (клиент)   │     │   + Orchestrator  │     │  (хранилище)│
└─────────────┘     └────────┬─────────┘     └──────▲──────┘
       │                     │                      │
       │                     ▼                      │
       │             ┌───────────────┐              │
       │             │ Gemini 2.5     │              │
       │             │ (Files API +   │              │
       │             │  Structured     │              │
       │             │  Output)        │              │
       │             └───────┬─────────┘              │
       │                     │                       │
       │                     ▼                       │
       │             ┌───────────────┐               │
       │             │ Task Executor  │───────────────┘
       │             │ (FFmpeg)      │   upload result
       │             └───────────────┘
       │
       └────────────  Presigned URL для скачивания
```

---

## 4. Тестовый веб-интерфейс

Простой UI для проверки системы без внешних клиентов. Раздаётся FastAPI как статика.

### 4.1 Назначение

- Загрузка видео и ввод промпта
- Запуск обработки
- Просмотр результата (превью)
- Скачивание готового видео

### 4.2 Структура экрана

```
┌─────────────────────────────────────────────────────────────────┐
│  AI Video Editing — Тестовый интерфейс                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Шаг 1: Загрузите видео                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [Перетащите файл сюда или нажмите для выбора]            │   │
│  │  video.mp4 (12.5 MB) ✓                                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  Шаг 2: Опишите, что сделать                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Наложи текст "Мой заголовок" сверху по центру,          │   │
│  │  обрежь до 30 секунд                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  [ Обработать ]                                                  │
│                                                                  │
│  ─── После обработки ───                                         │
│                                                                  │
│  Статус: Готово ✓                                                │
│                                                                  │
│  Превью результата:                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    <video controls>                       │   │
│  │                    [▶ воспроизведение]                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│  [ Скачать видео ]                                               │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 Поток в UI

1. **Загрузка** — drag-and-drop или выбор файла → запрос presigned URL → PUT в S3
2. **Промпт** — текстовое поле (textarea)
3. **Обработка** — кнопка «Обработать» → POST /process → индикатор загрузки
4. **Результат** — отображение статуса, превью через `<video src="download_url">`
5. **Скачивание** — кнопка открывает download_url в новой вкладке или триггерит download

### 4.4 Технические решения

| Аспект | Решение |
|--------|---------|
| Раздача | `StaticFiles` в FastAPI, папка `static/` |
| Сборка | Не требуется — HTML + vanilla JS + CSS |
| Запросы | `fetch()` к тем же эндпоинтам API |
| Превью | `<video>` с `src` = presigned URL |
| Обработка | Синхронный POST (для MVP), при долгой обработке — спиннер |

### 4.5 Файловая структура UI

```
static/
├── index.html      # Единая страница приложения
├── style.css       # Стили (опционально, можно inline)
└── app.js          # Логика: загрузка, process, превью, скачивание
```

### 4.6 UX-детали

- Сообщения об ошибках (валидация, таймаут, ошибка API)
- Disabled-состояние кнопок до загрузки видео и промпта
- Прогресс при длительной обработке («Обработка… может занять 1–2 минуты»)
- Поддержка только mp4 для MVP (можно расширить)

---

## 5. Поток данных

### 5.1 Загрузка видео

1. Клиент запрашивает presigned URL для загрузки
2. Загружает видео напрямую в S3 (минуя API)
3. Возвращает `video_s3_key` в запросе на обработку

### 5.2 Обработка (POST /process)

```
1. API получает: { video_s3_key, user_prompt }
2. Скачивает видео из S3 во временную директорию
3. Загружает видео в Gemini Files API (если >20MB) или передаёт inline (если <20MB)
4. Вызывает Gemini с:
   - Видео (file_uri или inline_data)
   - Промпт пользователя
   - response_schema (JSON Schema для задач)
5. Парсит JSON из ответа
6. Task Executor последовательно выполняет задачи через FFmpeg
7. Загружает результат в S3
8. Возвращает presigned URL для скачивания
```

### 5.3 Gemini — особенности

- **Files API** — для видео >20 MB или >1 мин
- **Inline** — для коротких видео <20 MB
- **Сэмплирование** — 1 FPS по умолчанию, настраивается через `video_metadata`
- **Structured Output** — `response_mime_type: application/json` + `response_schema`
- **Контекст** — до 1 часа видео при 1M контексте

---

## 6. JSON-схема задач

### 6.1 Структура

```json
{
  "tasks": [
    {
      "type": "add_text_overlay",
      "params": {
        "text": "Мой заголовок",
        "position": "top_center",
        "font_size": 48,
        "font_color": "white",
        "start_time": 0,
        "end_time": 10
      }
    },
    {
      "type": "trim",
      "params": {
        "start": 0,
        "end": 60
      }
    }
  ]
}
```

### 6.2 Типы задач (MVP)

| type | params | Описание |
|------|--------|----------|
| `add_text_overlay` | text, position, font_size, font_color, start_time?, end_time? | Наложение текста |
| `trim` | start, end | Обрезка по таймкодам |
| `resize` | width, height? | Изменение размера |
| `change_speed` | factor | Изменение скорости (0.5, 2.0 и т.д.) |

### 6.3 Расширяемые типы (будущее)

- `add_watermark`, `fade_in`, `fade_out`, `crop`, `rotate`, `add_audio` и т.д.

---

## 7. Инфраструктура MVP

### 7.1 Компоненты

| Компонент | Решение |
|-----------|---------|
| API | FastAPI на EC2 |
| UI | Статический HTML/JS из `static/` |
| Хранилище | S3 (bucket для input/output) |
| Обработка | FFmpeg на том же EC2 |
| Деплой | Docker-контейнер |
| Инстанс | t3.medium (4 vCPU, 16 GB RAM) |

### 7.2 Фазы реализации

**Фаза 1 — Локальная разработка**
- FastAPI + эндпоинты (upload URL, process, download URL)
- Интеграция Gemini (Files API + Structured Output)
- Task Executor (FFmpeg)
- **Тестовый UI** (HTML + JS): загрузка видео, промпт, превью, скачивание
- Тесты на локальных файлах

**Фаза 2 — AWS**
- S3 bucket, IAM-роли
- Docker-образ (FastAPI + FFmpeg + Python deps)
- EC2, деплой, проверка end-to-end

**Фаза 3 — Улучшения**
- SQS для асинхронной обработки (опционально)
- Polling/Webhook для статуса
- Расширение типов задач

---

## 8. Стек технологий

```
Backend:     Python 3.11+, FastAPI
Frontend:    HTML + vanilla JS + CSS (статический UI)
Video:       FFmpeg (subprocess / ffmpeg-python)
LLM:         Google Gemini 2.5 Flash (google-genai SDK)
Storage:     boto3 (S3)
Deploy:      Docker, EC2
```

### Зависимости (основные)

```
fastapi
uvicorn
google-genai
boto3
ffmpeg-python  # или subprocess к ffmpeg
python-multipart
```

---

## 9. API (черновик)

### POST /upload-url
**Request:** `{ "filename": "video.mp4" }`  
**Response:** `{ "upload_url": "...", "video_key": "uploads/xxx/video.mp4" }`  
*Используется UI для загрузки файла в S3*

### POST /process
**Request:** `{ "video_key": "uploads/xxx/video.mp4", "prompt": "Наложи текст X сверху, обрежь до 1 минуты" }`  
**Response:** `{ "output_key": "outputs/xxx/result.mp4", "download_url": "..." }`  
*UI отображает превью (video src=download_url) и кнопку скачивания*  
*Или асинхронно: `{ "job_id": "..." }` с последующим GET /jobs/{id}*

### GET /download-url
**Query:** `?key=outputs/xxx/result.mp4`  
**Response:** `{ "download_url": "..." }`

### GET /
**Response:** Статическая страница `index.html` (тестовый UI)

---

## 10. Риски и митигации

| Риск | Митигация |
|------|-----------|
| Длинное видео → много токенов | Ограничить длительность или использовать low media_resolution |
| Большие файлы | Files API, лимит загрузки в API |
| FFmpeg-ошибки | Валидация JSON, fallback, логирование |
| Таймаут обработки | Асинхронный режим (SQS) при необходимости |
| Стоимость Gemini | Ограничение длины, кэширование при повторных запросах |

---

## 11. Безопасность

- Presigned URLs с коротким TTL (15–60 мин)
- Валидация MIME-типов загружаемых файлов
- Ограничение размера файлов
- Секреты (API keys) через переменные окружения
- IAM с минимальными правами для S3

---

## Следующий шаг

После подтверждения — переход к **Фазе 1: реализация кода** (локально).
